# JavaScript-Execute-stack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    /**
     * 不同宿主环境中 ES 扮演着不同的角色
     * 
     * ES: 基础语言
     */

    + --- Browser ------------------- +
    |                                 |
    |                                 |
    |    In the browser environment   |             * 在浏览器环境中的 ES 被称为 JavaScript
    |    ES is called JS              |
    |                                 |
    |    WebAPI                       |
    |                                 |
    |   + --------------------- +     |
    |   |                       |     |
    |   |      ES Language      |     |
    |   |                       |     |
    |   + --------------------- +     |
    |                                 |
    + ------------------------------- +


    + --- Server -------------------- +
    |                                 |
    |                                 |
    |    In the server environment    |             * 在服务器环境中的 ES 被称为 Node
    |    ES is called Node            |
    |                                 |
    |    NodeAPI                      |
    |                                 |
    |   + --------------------- +     |
    |   |                       |     |
    |   |      ES Language      |     |
    |   |                       |     |
    |   + --------------------- +     |
    |                                 |
    + ------------------------------- +


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### Call Stack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



    /**
     * 执行栈( call stack )            // 用于暂时存储各种函数的执行环境
     * 
     * 
     * 1) 当函数执行时，会创建一个称为 '执行期上下文' 的全局内部对象
     *  
     * 2) 一个执行期上下文定义了一个函数执行时的环境，函数每次执行时对应的执行上下文都是独一无二的
     *  
     * 3) 多次调用一个函数会导致创建多个执行上下文，当函数执行完毕，执行上下文被销毁
     */


    /**
     * 
     * JS 引擎永远优先执行栈顶的任务
     * 
     */


                     + ----------------------- +
                     |                         |
                   + |    new execut task      | +
                   | |                         | |
     push stack ---- + ----------------------- + |
                   |                             |
                   |                             |
                   |                             |
                   |                             |
                   | + ----------------------- + ---- always execute first task
                   | |                         | |      
     stack top ----- |    first execut task    | |
                   | |                         | |
                   | + ----------------------- + ---- pop stack
                   | + ----------------------- + |
                   | |                         | |
                   | |           ...           | |
                   | |                         | |
                   | + ----------------------- + |
                   | + ----------------------- + |
                   | |                         | |
     stack bottom -- |    last execut task     | |
                   | |                         | |
                   | + ----------------------- + ---- first in, last out
                   + --------------------------- +
                           
                              Call Stack


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


    function a() {

        console.log('a');
        b();
    }

    function b() {

        console.log('b');
        c();
    }

    function c() {

        console.log('c');
    }

    console.log('global');
    a();


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


    function getFibonacci(num) {

        if (num === 1 || num === 2) {

            return 1;

        } else {

            return getFibonacci(num - 1) + getFibonacci(num - 2);
        }
    }


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


- JS 引擎线程: 

    - 解释执行 JS 代码、用户输入、网络输入
    
    - JS 引擎线程 和 GUI 线程执行时，会相互等待，等待另一个执行后，再执行

- GUI 线程: 

    - 绘制用户界面 和 JS 主线程互斥

    - JS 操作 DOM 元素时，会影响 GUI 的渲染结果，因此 JS 引擎线程与GUI渲染是互斥的
    
    - 当 JS 引擎线程处于运行状态，GUI 渲染线程将处于冻结状态

- HTTP 网络请求线程: 

    - 处理用户的 get、post 等请求，等返回结果后将回掉函数推入任务队列
    
- 定时触发器线程:

    - setTimeout、setInterval 等事件结束后执行函数推入任务队列
    
- 浏览器事件监听线程

    - 将 click、mouse 等交互事件发生后将这些事件放入事件队列中


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


     /**
     * Browser Event Loop
     * 
     * 
     * 当下面的线程发生了某些事件时
     * 
     * 若该线程发现，此任务片段在浏览器环境中有执行它的线程，则会把它添加到指定线程中
     * 
     * 除 GUI 线程外，其他线程执行完任务片段，会把执行后的结果添加到 事件循环队列 等待执行    // 争抢任务序列
     * 
     * 当 执行栈中无任务时，会将事件循环队列中的第一个事件添加到执行栈中执行
     */

                                                           // @unsettle: 未决阶段，事件初期或事件处理中，还未有结果
                                                           
              new execut task                                      |     ES6-Event-Pending      |
               + --------- +                                       + - - - - unsettle - - - - - +
               |           |                                       |                            |
            + -|- - - - - -|- +                                        Asynchronous execution      
            |  + --------- +  |                                    |                            |  
            |                 |                                         + ----------------- +      
            |                 |                                    |    |                   |   |  
            |                 | ----------------------------- + --- --> |  Event listener   |      
            |                 |                               |    |    |  thread           |   |  
            |                 |                               |         |                   |      
            |                 |                               |    |    + ----------------- +   |  
            |                 |                               |                                    
            |                 |     + ------------------- +   |    |    + ----------------- +   |  
            |                 |     |                     |   |         |                   |      
            | + ----------- + |     |      GPU Print      |   + ---|--> |  Network request  |   |  
            | |             | |     |                     |   |         |  thread           |      
            | |     ...     | |     | - - - - - - - - - - |   |    |    |                   |   | 
            | |             | |     |                     |   |         + ----------------- +      
            | + ----------- + |     |  domTree + cssTree  |   |    |                            |  
            | + ----------- + |     |                     |   |         + ----------------- +     
            | |             | |     |      renderTree     |   |    |    |                   |   |  
            | |  Global OA  | |     |                     |   + --- --> |  Timer trigger    |      
            | |             | |     |         ...         |        |    |  thread           |   |  
            | + ----------- + |     |                     |             |                   |     
            + --------------- +     + ------------------- +        |    + ----------------- +   |  
                Call Stack          Graphical User Interface       + - - - - - -  | | - - - - - +
                                                                                  | |
        + - - - -  / \  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - | | - - - - - - - - - +
        |         /| |\                                                           | |                   |
                   | |              + ---- ES6-Event-Rejected ---- +    Event-Asynchronous-result              
        |          | |              |                              |              | |                   | 
                   | |              |  NetworkError, RequestError  |              | |                   
        |          | |              |  ...                         | <------------| |                   |
                   | |              |                  'catchable' | <------------| |                   
        |          | |              |                              |              | |                   |
                   | |              + ---------------------------- +              | |                   
        |          | |                                                           \| |/                  |
           + ------| |-------------------- ES6-Event-Resolved ------------------- \ / ----------- +                  
        |  |       | |                                                         'thenable'         |     |  
           |                                                                                      |        
        |  |                                                                                      |     |  
           |  | event queue                                                                       |    
        |  |  |                      + --- Macro queue: Timer, Event, Network ...                 |     |
           |  |                      |     // Relatively late execution                           |          
        |  |  | Javascript <- ... <- +                                                            |     |
           |  |  callback            |                                                            |     
        |  |                         + --- micro queue: mutationObserver, Promise ...             |     |
           |                               // Relative priority                                   |      
        |  |                                                                                      |     |
           |                               * mutationObserver: Fires when the Dom element changes |                
        |  |                                                   (attribute, childList, subtree)    |     |
           |                                                                                      |          
        |  +------------------------------------------------------------------------------------- +     |                 
                                                                                                         
        |                                                                                               |
        + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - resulted settle - - - - - - +

                                                       // @settle: 已决阶段，事件已有处理结果
                                                       // mutationObserver: 监听的 Dom 元素改变时触发
    /**
     * ES6 Asynchronous Event
     * 
     * 
     * @Pending( 挂起 ):       未决阶段，事件初期或事件处理中，还未有结果
     * 
     * @Resolved( 已处理 ):    已决阶段，事件已有处理结果，并添加事件队列正常执行
     * 
     * @Rejected( 已拒绝 ):    已决阶段，事件已有处理结果，但结果无法按照正常逻辑执行( 通常为一个错误 )
     */


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


/**
 * 当事件处理到达 '已决阶段'，通常需要进行后续处理，不同的已决状态，决定了不同的后续处理
 * 
 * 
 * resolved: 正常的已决状态，后续处理表示为 thenable
 * 
 * rejected: 非正常已决状态，后续处理表示为 catchable
 */

                                                                            + -resolved queue-- +
                                                                            |                   |
                                                                            |                   |
                                                                            | + ------------- + |
+ ----- unsettled ----- +                 + ------ settled ------ +         | |  thenable-1   | |
|                       |                 |                       |         | + ------------- + |
|                       |                 |                       |         | + ------------- + |
| + ----------------- + |                 | + ----------------- + |         | |  thenable-1   | |
| |                   | |                 | |                   | |         | + ------------- + |
| |                   | |  resolove-data  | |  resoloved-data   | |========>| + ------------- + |
| |                   | |  ============>  | |                   | |         | |  thenable-1   | |
| |                   | |                 | |                   | |         | + ------------- + |
| |                   | |                 | + ----------------- + |         + ----------------- +
| |    ES6-Pending    | |                 |                       |                              
| |                   | |                 | + ----------------- + |         + -rejected queue-- +
| |                   | |                 | |                   | |         |                   |
| |                   | |  reject-data    | |  rejected-data    | |========>|                   |
| |                   | |  ============>  | |                   | |         | + ------------- + |
| |                   | |                 | |                   | |         | |  catchable-1  | |
| + ----------------- + |                 | + ----------------- + |         | + ------------- + |
+ --------------------- +                 + --------------------- +         | + ------------- + |
                                                                            | |  catchable-1  | |
                                                                            | + ------------- + |
                                                                            | + ------------- + |
                                                                            | |  catchable-1  | |
                                                                            | + ------------- + |
                                                                            + ----------------- +


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```
